<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sight Word Matcher: Level Progression</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS styles remain the same for visual consistency */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .game-card {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            padding: 2rem;
            text-align: center;
        }
        .score-display {
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 1rem;
        }
        .word-container {
            min-height: 80px;
            font-size: 3rem;
            font-weight: 700;
            color: #334155;
            margin-bottom: 2rem;
        }
        .image-box {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            font-size: 8rem;
            margin-bottom: 1.5rem;
            border-radius: 10px;
            background-color: #e2e8f0;
        }
        .word-button {
            transition: all 0.1s ease;
            cursor: pointer;
            user-select: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 2rem;
            font-weight: 700;
            margin: 5px;
            min-width: 120px;
        }
        .word-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }
        .correct-answer-button {
            background-color: #4ade80 !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        .incorrect-answer-button {
            background-color: #f87171 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }
        .difficulty-indicator {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 700;
            margin-top: -1rem;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="game-card">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Find the Sight Word!</h1>
        
        <div class="flex justify-center items-center mb-4">
            <span id="levelIndicator" class="difficulty-indicator bg-indigo-200 text-indigo-700 mr-4">LEVEL 1</span>
            <span id="difficultyIndicator" class="difficulty-indicator bg-blue-200 text-blue-700">FEW CHOICES</span>
        </div>
        
        <div id="scoreDisplay" class="score-display">Progress: 0 / 10</div>

        <div id="imageBox" class="image-box text-center">
        </div>

        <div id="sentenceDisplay" class="word-container flex justify-center mb-8 italic">
        </div>

        <div id="mx-auto flex justify-center">
            <div id="wordButtons" class="flex justify-center gap-4 flex-wrap max-w-lg">
            </div>
        </div>

        <p id="feedback" class="text-xl h-6 font-semibold mt-6 text-gray-600"></p>
    </div>

    <script>
        // --- Game Data: Structured Levels (10 words each) ---
        const gameLevels = [
            // Level 1: Kindergarten (Dolch Pre-Primer/Primer Focus) - 10 Words
            {
                name: "Level 1: Beginner",
                words: [
                    { word: "THE", sentence: "Look at ____ sun!", emoji: "â˜€ï¸" },
                    { word: "IS", sentence: "The bug ____ small.", emoji: "ðŸ›" },
                    { word: "AND", sentence: "I like dogs ____ cats.", emoji: "ðŸ•ðŸˆ" },
                    { word: "A", sentence: "I see ____ little house.", emoji: "ðŸ " },
                    { word: "TO", sentence: "We go ____ the park.", emoji: "ðŸŒ³" },
                    { word: "IN", sentence: "The fish is ____ the water.", emoji: "ðŸ’§" },
                    { word: "IT", sentence: "____ is my turn now.", emoji: "ðŸ™‹" },
                    { word: "OF", sentence: "A box ____ toys.", emoji: "ðŸŽ" },
                    { word: "WAS", sentence: "She ____ running fast.", emoji: "ðŸƒâ€â™€ï¸" },
                    { word: "FOR", sentence: "This gift is ____ you.", emoji: "ðŸŽ" }
                ]
            },
            // Level 2: First Grade (Dolch Primer/Grade 1 Focus) - 10 Words
            {
                name: "Level 2: Intermediate",
                words: [
                    { word: "HAVE", sentence: "I ____ a new friend.", emoji: "ðŸ¤" },
                    { word: "FROM", sentence: "The letter is ____ Mom.", emoji: "âœ‰ï¸" },
                    { word: "BUT", sentence: "I want a cookie, ____ I can't.", emoji: "ðŸª" },
                    { word: "NOT", sentence: "The ball is ____ red.", emoji: "ðŸˆ" },
                    { word: "ALL", sentence: "We ate ____ the food.", emoji: "ðŸ•" },
                    { word: "WERE", sentence: "They ____ happy to play.", emoji: "ðŸ˜Š" },
                    { word: "WHEN", sentence: "____ will we go home?", emoji: "ðŸ¡" },
                    { word: "ARE", sentence: "You ____ a good helper.", emoji: "ðŸ‘" },
                    { word: "SAID", sentence: "She ____ 'Hello'.", emoji: "ðŸ—£ï¸" },
                    { word: "LIKE", sentence: "I ____ to read books.", emoji: "ðŸ“š" }
                ]
            },
            // Level 3: Second Grade (Dolch Grade 2 Focus) - 10 Words
            {
                name: "Level 3: Advanced",
                words: [
                    { word: "ALWAYS", sentence: "He ____ wears a hat.", emoji: "ðŸŽ©" },
                    { word: "BOTH", sentence: "____ my shoes are new.", emoji: "ðŸ‘Ÿ" },
                    { word: "FAST", sentence: "The car goes very ____.", emoji: "ðŸš—" },
                    { word: "READ", sentence: "Can you ____ this story?", emoji: "ðŸ“–" },
                    { word: "YOUR", sentence: "Is this ____ coat?", emoji: "ðŸ§¥" },
                    { word: "BEFORE", sentence: "Wash hands ____ eating.", emoji: "ðŸ§¼" },
                    { word: "BETTER", sentence: "This way is ____.", emoji: "âœ…" },
                    { word: "CALL", sentence: "Please ____ me later.", emoji: "ðŸ“ž" },
                    { word: "SIT", sentence: "Please ____ down here.", emoji: "ðŸª‘" },
                    { word: "TELL", sentence: "____ me a secret!", emoji: "ðŸ¤«" }
                ]
            }
        ];

        // --- Audio & Speech Setup (Unchanged) ---
        const correctSynth = new Tone.Synth({
            oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
        }).toDestination();
        const incorrectSynth = new Tone.Synth({
            oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.05, sustain: 0.01, release: 0.1 }
        }).toDestination();
        const speech = new SpeechSynthesisUtterance();
        speech.lang = 'en-US'; 
        speech.rate = 0.8;      

        // --- Game State Variables ---
        let currentLevelIndex = 0;              // Start at Level 1 (index 0)
        let masteredWords = new Set();          // Tracks words correctly answered in the current level
        let currentWordData = {};
        let correctStreak = 0;                  // Used for dynamic choice difficulty
        const DIFFICULTY_THRESHOLD = 5;

        // DOM Elements
        const imageBox = document.getElementById('imageBox');
        const sentenceDisplayEl = document.getElementById('sentenceDisplay');
        const wordButtonsContainer = document.getElementById('wordButtons');
        const feedbackEl = document.getElementById('feedback');
        const scoreDisplayEl = document.getElementById('scoreDisplay');
        const difficultyIndicatorEl = document.getElementById('difficultyIndicator');
        const levelIndicatorEl = document.getElementById('levelIndicator');


        // --- UTILITY FUNCTIONS ---
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function playCorrectSound() {
            const now = Tone.now();
            correctSynth.triggerAttackRelease("C5", "16n", now);
            correctSynth.triggerAttackRelease("E5", "16n", now + 0.1); 
            correctSynth.triggerAttackRelease("G5", "8n", now + 0.2); 
        }

        function playIncorrectSound() {
            incorrectSynth.triggerAttackRelease("C3", "16n");
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            speech.text = text;
            window.speechSynthesis.speak(speech);
        }

        function setFemaleVoice() {
             // (Logic to set preferred voice remains the same)
            const voices = window.speechSynthesis.getVoices();
            const femaleVoice = voices.find(voice => 
                voice.lang === 'en-US' && 
                (voice.name.includes('Female') || voice.name.includes('Zira') || voice.name.includes('Samantha'))
            );
            if (femaleVoice) {
                speech.voice = femaleVoice;
            }
        }
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = setFemaleVoice;
        } else {
            setFemaleVoice();
        }

        // --- LEVEL MANAGEMENT FUNCTIONS ---

        function updateGameStatus() {
            // Update Score/Progress
            scoreDisplayEl.textContent = `Progress: ${masteredWords.size} / ${gameLevels[currentLevelIndex].words.length}`;
            
            // Update Level Indicator
            levelIndicatorEl.textContent = gameLevels[currentLevelIndex].name.toUpperCase();
            
            // Update Difficulty Indicator (for number of choices)
            if (correctStreak >= DIFFICULTY_THRESHOLD) {
                difficultyIndicatorEl.textContent = "MORE CHOICES";
                difficultyIndicatorEl.classList.remove('bg-blue-200', 'text-blue-700');
                difficultyIndicatorEl.classList.add('bg-red-200', 'text-red-700');
            } else {
                difficultyIndicatorEl.textContent = "FEW CHOICES";
                difficultyIndicatorEl.classList.add('bg-blue-200', 'text-blue-700');
                difficultyIndicatorEl.classList.remove('bg-red-200', 'text-red-700');
            }
        }
        
        function loadNextLevel() {
            currentLevelIndex++;
            masteredWords.clear(); // Reset mastered words for the new level
            
            if (currentLevelIndex >= gameLevels.length) {
                // Game Over / All Levels Complete
                feedbackEl.textContent = "CONGRATULATIONS! You mastered all levels!";
                speakText("Congratulations! You mastered all three levels!");
                // Optionally hide buttons, display final screen
                wordButtonsContainer.innerHTML = '';
                imageBox.textContent = 'ðŸ†';
                sentenceDisplayEl.textContent = 'Game Complete!';
                return;
            }
            
            // Announce the new level
            const newLevelName = gameLevels[currentLevelIndex].name;
            feedbackEl.textContent = `LEVEL UP! Starting ${newLevelName}!`;
            speakText(`Level up! Starting ${newLevelName}!`);
            
            // Reset streak and load first problem of the new level
            correctStreak = 0;
            setTimeout(loadNewProblem, 3000); 
        }

        // Function to select a random word *not yet mastered* in the current level
        function loadNewProblem() {
            // Stop if game is complete
            if (currentLevelIndex >= gameLevels.length) return; 

            const currentLevelWords = gameLevels[currentLevelIndex].words;
            
            // Get all words in the current level that haven't been mastered
            const unmasteredWords = currentLevelWords.filter(w => !masteredWords.has(w.word));

            if (unmasteredWords.length === 0) {
                // Level is complete!
                loadNextLevel();
                return; 
            }
            
            // Shuffle and pick a word from the unmastered list
            shuffleArray(unmasteredWords);
            
            // Select a new word, avoiding the previous word if possible
            const availableForSelection = unmasteredWords.filter(w => w.word !== currentWordData.word);
            currentWordData = availableForSelection[0] || unmasteredWords[0];
            
            feedbackEl.textContent = '';
            updateGameStatus();

            // Update display and speech
            imageBox.textContent = currentWordData.emoji;
            sentenceDisplayEl.textContent = currentWordData.sentence;
            const speechText = currentWordData.sentence.replace('____', '... blank ...');
            speakText(speechText);

            generateWordButtons(currentWordData.word);
        }

        // Function to create the set of clickable word buttons (Distractor logic remains the same)
        function generateWordButtons(targetWord) {
            wordButtonsContainer.innerHTML = '';
            
            // Use ALL words from the current level as potential distractors
            const currentLevelWords = gameLevels[currentLevelIndex].words;
            const numChoices = (correctStreak >= DIFFICULTY_THRESHOLD) ? 5 : 3; 
            
            const distractors = currentLevelWords
                .map(w => w.word)
                .filter(word => word !== targetWord);
            
            shuffleArray(distractors);

            const buttonWords = [targetWord, ...distractors.slice(0, numChoices - 1)];
            
            shuffleArray(buttonWords); 

            buttonWords.forEach(word => {
                const button = document.createElement('button');
                button.textContent = word;
                button.classList.add('word-button', 'bg-purple-400', 'text-white', 'shadow-md');
                button.addEventListener('click', () => handleWordClick(word, button));
                wordButtonsContainer.appendChild(button);
            });
        }

        // --- EVENT HANDLER ---

        function handleWordClick(clickedWord, buttonElement) {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            
            window.speechSynthesis.cancel();
            Array.from(wordButtonsContainer.children).forEach(btn => btn.disabled = true);

            if (clickedWord === currentWordData.word) {
                // Correct Answer
                buttonElement.classList.add('correct-answer-button');
                playCorrectSound();
                
                // Add to mastered set
                masteredWords.add(currentWordData.word); 

                feedbackEl.textContent = "YES! " + currentWordData.word + " fits!";
                correctStreak++;

                const completedSentence = currentWordData.sentence.replace('____', currentWordData.word);
                speakText(currentWordData.word + ". " + completedSentence);

                // Load next problem or level
                setTimeout(loadNewProblem, 3000);

            } else {
                // Incorrect Answer
                playIncorrectSound();
                feedbackEl.textContent = "Not quite! Try another word.";
                buttonElement.classList.add('incorrect-answer-button');
                
                // Reset streak on error
                correctStreak = 0; 
                updateGameStatus();

                // Reset button appearance and re-enable choices
                setTimeout(() => {
                    buttonElement.classList.remove('incorrect-answer-button');
                    feedbackEl.textContent = '';
                    Array.from(wordButtonsContainer.children).forEach(btn => {
                        if (btn !== buttonElement) {
                             btn.disabled = false;
                        } else {
                             btn.style.opacity = '0.5'; // Visually mark the wrong choice
                        }
                    });
                    
                    // Re-speak the sentence prompt after a mistake to refocus the child
                    const speechText = currentWordData.sentence.replace('____', '... blank ...');
                    speakText(speechText);

                }, 1000);
            }
        }

        // --- INITIALIZATION ---
        window.onload = loadNewProblem;

    </script>
</body>
</html>
